### MySQL 存储过程

存储过程（Stored Procedure）是一种在数据库中存储复杂程序，以便外部程序调用的一种数据库对象。

Stored 英 /stɔ:(r)d/  美 /stɔ(r)d/ v. 储存；容纳（store 的过去式和过去分词）
Procedure 英 /prəˈsiːdʒə(r)/  美 /prəˈsiːdʒər/ n. 程序，手续；步骤 复数 procedures

存储过程是为了完成特定功能的SQL语句集，经编译创建并保存在数据库中，用户可通过指定存储过程的名字并给定参数(需要时)来调用执行。

存储过程思想上很简单，就是数据库 SQL 语言层面的代码封装与重用。

优点
> 
存储过程可封装，并隐藏复杂的商业逻辑。
存储过程可以回传值，并可以接受参数。
存储过程无法使用 SELECT 指令来运行，因为它是子程序，与查看表，数据表或用户定义函数不同。
存储过程可以用在数据检验，强制实行商业逻辑等。


缺点
> 
存储过程，往往定制化于特定的数据库上，因为支持的编程语言不同。当切换到其他厂商的数据库系统时，需要重写原有的存储过程。
存储过程的性能调校与撰写，受限于各种数据库系统。

### 一、存储过程的创建和调用

* 存储过程就是具有名字的一段代码，用来完成一个特定的功能。
* 创建的存储过程保存在数据库的数据字典中。

#### 创建存储过程
```
create procedure sp_name ([in | out |inout] parameter type) 
	[characteristic][特征] routine_body常规体(存储过程体)
[begin_label:] begin [开始标签：]
	[statement_list 声明列表]
	...
end [结束标签]

characteristic: （特征）
	comment 'string' （注释 '字符'） 
	| language SQL (语言 SQL)
	| [not] deterministic ([非] 确定的)
	| { contains sql | no sql | reads sql data | modifies sql data } （包含 SQL | 非 SQL | 读取 sql 数据 | 修改 sql 数据）
	| sql security { definer | invoker} （sql 安全性 { 定义者 | 请求者}）

routine_body: (常规 主体)
 valid sql routine statement有效的SQL例行声明

```

definer 定义者 n. 定义者（define的名词形式）
delimiter 定界符 英 /dɪ'lɪmɪtə/  美 /dɪ'lɪmɪtɚ/ n. [计] 定界符
procedure 程序 过程 英 /prəˈsiːdʒə(r)/  美 /prəˈsiːdʒər/ n. 程序，手续；步骤 复数 procedures
parameter 参数 英 /pəˈræmɪtə(r)/  美 /pəˈræmɪtər/ n. 参数；系数；参量 复数 parameters
declare 声明 英 /dɪˈkleə(r)/  美 /dɪˈkler/ vt. 宣布，声明；断言，宣称 vi. 声明，宣布 过去式 declared过去分词 declared现在分词 declaring第三人称单数 declares
unsigned 无符号的 英 /ʌn'saɪnd/  美 /ʌn'saɪnd/ adj. 无符号的；未签名的
characteristic 特征 特色 英 /ˌkærəktəˈrɪstɪk/  美 /ˌkærəktəˈrɪstɪk/ adj. 典型的；特有的；表示特性的 n. 特征；特性；特色 复数 characteristics
routine 例行 常规 英 /ruːˈtiːn/  美 /ruːˈtiːn/ n. 常规，惯例；生活乏味；（演出中的）一套动作；（计算机）例行程序 adj. 常规的，例行的；平常的；乏味的 v. 按惯例安排
comment 注释  英 /ˈkɒment/  美 /ˈkɑːment/ n. 评论；意见；批评；描述 vt. 发表评论；发表意见 vi. 为……作评语
deterministic 确定的 英 /dɪˌtɜːmɪˈnɪstɪk/  美 /dɪˌtɜːrmɪˈnɪstɪk/ adj. 确定性的；命运注定论的
contains 英 /kən'teinz/  v. 包含，容纳；控制，克制；由……组成；可整除；防止……蔓延（contain 的第三人称单数）
security 安全性 安全 英 /sɪˈkjʊərəti/  美 /sɪˈkjʊrəti/  n. 安全，安全性；保证；证券；抵押品 adj. 安全的；保安的；保密的
valid 英 /ˈvælɪd/  美 /ˈvælɪd/ adj. 有效的；有根据的；合法的；正当的
statement 声明 英 /ˈsteɪtmənt/  美 /ˈsteɪtmənt/ n. 声明；陈述，叙述；报表，清单 复数 statements过去式 statemented过去分词 statemented现在分词
invoker 请求者 祈求者 /in'vəukə/ n. 祷告者，祈求者 
lable 英[ˈleɪbl] 美[ˈleɪbl] n.	标签; 签条; 标记; (不恰当的) 称谓，绰号，叫法; 唱片公司; v.	贴标签于; 用标签标明; (尤指不公正地) 把…称为;


##### MYSQL 存储过程中的关键语法

1. 声明语句结束符，可以自定义:
```
definer $$
或
delimiter //
```

2. 声明存储过程:
```
create procedure demo_in_parameter(in parameter int)
```

3. 存储过程开始和结束符号:
```
begin ... end
```

4. 变量赋值:
```
set @parameter = 1
```

5. 变量定义:
```
declare parameter int unsigned default 4000000;
```

6. 创建mysql存储过程、存储函数:
```
create procedure 存储过程名(参数)
```

7. 存储过程体:
```
create function 存储函数名(参数)
```

##### 实例
* 创建数据库，备份数据表用于示例操作：
```

```

tennis 英 /ˈtenɪs/  美 /ˈtenɪs/ n. 网球（运动）
matches  英 /'mætʃɪz/  美 /'mætʃɪz/ n. 比赛（match的复数）；火柴 v. 匹配（match的第三人称单数形式）；匹敌

```
delimiter $$
create procedure delete_people(in id integer)
begin
	delete from incarnation
	where id = id
end
delimiter;
```

matches 英 /'mætʃɪz/  美 /'mætʃɪz/  n. 比赛（match的复数）；火柴 v. 匹配（match的第三人称单数形式）；匹敌
integer 英 /ˈɪntɪdʒə(r)/  美 /ˈɪntɪdʒər/ n. 整数
integer(p) -> 整数值（没有小数点）。精度 10。
drop 英 /drɒp/  美 /drɑːp/ v. 推动；帮助；宣扬；下降；终止 n. 滴；落下；空投；微量；滴剂
exists 英 /ɪɡˈzɪsts/  美 /ɪɡˈzɪsts/ n. 存在量词（exist的复数） v. 存在；出现；活着（exist的三单形式）

解析：默认情况下，存储过程和默认数据库相关联，如果想指定存储过程创建在某个特定的数据库下，那么在过程名前面加数据库名做前缀。 在定义过程时，使用 DELIMITER $$ 命令将语句的结束符号从分号 ; 临时改为两个 $$，使得过程体中使用的分号被直接传递到服务器，而不会被客户端（如mysql）解释。

调用存储过程：

```
call stored_procudure[(传参)]
```

##### 存储过程体

* 存储过程体包含了在过程调用时必须执行的语句，例如：dml、ddl语句，if-then-else和while-do语句、声明变量的declare语句等
* 过程体格式：以begin开始，以end结束(可嵌套)
```
begin
	begin
		statemnet声明;
	end
end
```
注意：每个嵌套块及其中的每条语句，必须以分号结束，表示过程体结束的begin-end块(又叫做复合语句compound statement)，则不需要分号。
为语句块贴标签:
```
[begin_label:] BEGIN
　　[statement_list]
END [end_label]
```
```
label1: BEGIN
　　label2: BEGIN
　　　　label3: BEGIN
　　　　　　statements; 
　　　　END label3 ;
　　END label2;
END label1
```

标签有两个作用：
* 
1、增强代码的可读性
2、在某些语句(例如:leave和iterate语句)，需要用到标签




